<?npl
--[[
Title: packages
Author: Big
Date: 2016/10/1
]]

include_once(WIKI_ROOT.."models/abstract/multi_user_base.page");
include_once(WIKI_ROOT.."models/user.page");
include_once("./packages_stats.page");

local packages = inherit(models.abstract.multi_user_base, gettable("models.packages"));

packages.db_name = "packages";

function packages:ctor()
	--package name
	self:addfield("projectName", "string", false, 30);
	--package description
	self:addfield("projectDesc", "string", false, 150);
	--package description
	self:addfield("version", "string", false, 10);
	--npl package or paracraft mod
	self:addfield("projectType", "string", false, 20);
	--github reponsity
	self:addfield("projectGitURL", "string", false, 300);
	--releases url
	self:addfield("projectReleases", "string", false, 300);
	--user name
	self:addfield("displayName", "string", false, 50);
	--is verified
	self:addfield("isVerified","string",false,10);
	--user ID number
	self:addfield("userid","number",false,10);
	--page amount
	self:addfield("amount","number",false,10);
	--page number
	self:addfield("page","number",false,10);
end

function packages:get(params)
	self:ensureAuthenticated();
	local err, query = self:validateQuery(params);
	log({"query",query});

	local userid;

	if(query.userid ~= -1 and not query.userid) then
		userid = self:getUserId();
	else
		userid = query.userid;
	end

	log({userid=userid});

	if(userid ~= -1 and not userid) then
		return {error=-1,msg="userid is not set"};
	elseif(userid == -1) then
		userid = false;
	end

	if(not query.projectType) then
		return {result = -1, msg = "projectType is not set"};
	end

	--if(not params.order) then
		--return {result = -1, msg = "order is not set"};
	--end

	if(not query.page) then
		query.page   = 1;
	end

	if(not query.amount) then
		query.amount = 4;
	end

	local skip  = query.page == 1 and 0 or query.page*query.amount-query.amount
	local limit = query.amount;

	data = {};

	--log({"self:getUserId()",self:getUserId()})
	if(userid) then
		self:db():find({["+projectType+userId-projectUpdate"] = {query.projectType,userid,limit=limit,skip=skip}}, resume);
	else
		self:db():find({["+projectType-projectUpdate"] = {query.projectType,limit=limit,skip=skip}}, resume);
	end

	local err,data = yield(true);

	return data;
end

function packages:api_createPackage(params)
	returnData = {};
	self:ensureAuthenticated();
	local err, query = self:validateQuery(params);

	if(not self:getUserId()) then
		return {result = "-1",msg = "This API must be authentication"};
	end

	if(query.projectReleases == "") then
		query.projectReleases = query.projectGitURL..'/archive/master.zip';
	end

	if(query.version == "") then
		query.version = "0.0.1"
	end

	self:db():insertOne(nil,
		{
			projectName     = query.projectName,
			projectDesc     = query.projectDesc,
			version		    = query.version,
			projectType     = query.projectType,
			projectGitURL   = query.projectGitURL,
			projectReleases = query.projectReleases,
			projectUpdate	= ParaGlobal.GetDateFormat("yyyy-MM-dd"),
			userId          = self:getUserId(),
			displayName     = query.displayName,
			installTimes	= 0,
			isVerified		= "false"
		 },
		 resume
	);

	local err,response = yield(true);

	if(not err) then
		local err = models.packages_stats:new():recordCreate(query.projectType);
		if(not err) then
			returnData = {result = "1",msg = "Create Successful!"};
		else
			returnData = {result = "-1",msg = "Create fail!"};
		end
	else
		returnData = {result = "-1",msg = "Create fail!"};
	end

	return returnData;
end

function packages:api_getOnePackage(params)
	data = {};

	self:db():findOne({_id=params.packageId},
		function(err, response)
			data = response;
			resume();
		end
	);
	yield();

	return data;
end

function packages:api_modifyPackage(params)
	self:ensureAuthenticated();
	local err, query = self:validateQuery(params);

	if(not self:getUserId()) then
		return {result = "-1",msg = "This API must be authentication"};
	end

	data = {};

	self:db():updateOne(
		{_id = query.packageId},
		{projectName     = query.projectName,
		 projectDesc     = query.projectDesc,
		 projectGitURL   = query.projectGitURL,
		 projectUpdate	 = ParaGlobal.GetDateFormat("yyyy-MM-dd"),
		 projectReleases = query.projectReleases,
		 version         = query.version},
		resume
	);

	local err,data = yield(true);

	return data;
end

function packages:api_deletePackage(params)
	returnData = {};

	if(not params.packageId) then
		return {result=-1,msg="packageId is not set"};
	end

	local projectType = "";

	self:db():findOne(
		{_id=params.packageId},
		function(err,response)
			projectType = response.projectType;
		end
	);

	self:db():deleteOne(
		{_id=params.packageId},
		function(err, count)
			if(count == 1) then
				returnData = {result=1,msg="Delete package success"};
				resume();
			else
				return {result=-1,msg="Delete package fail"};
			end
		end
	);
	yield();

	models.packages_stats:new():recordDelete(projectType);
	return returnData;
end

function packages:api_download(params)
	if(not params.projectType) then
		return {result=-1,msg="projectType is not set"};
	end

	if(not params.packageId) then
		return {result=-1,msg="packageId is not set"};
	end

	self:db():findOne({_id = params.packageId},resume);

	local err,response = yield(true);

	if(not err) then
		
		local installTimes = response.installTimes+1;

		self:db():updateOne({_id = params.packageId},{installTimes=installTimes},resume);
		local err,response = yield(true);

	end

	models.packages_stats:new():recordDownload(params.projectType);

	return {result="1",msg="download successful"};
end

function packages:api_getPackagesStats(params)
	return models.packages_stats:new():packagesStats(params);
end

function packages:api_getDownloadStats(params)
	return models.packages_stats:new():downloadStats(params);
end

function packages:setVerify(packagesId,isVerified)
	self:db():updateOne({_id=packagesId},{isVerified=isVerified},resume);
	local err,response = yield(true);

	if(not err) then
		return {error = 1 ,msg="set successful"};
	else
		return {error = -1,msg="set fail"};
	end
end

function packages:api_verifyPackages(params)
	local userParams = {};
	userParams._id = self:getUserId();
	local userResponse = models.user:new():get(userParams);
	
	if(userResponse.isadmin == "true") then
		return self:setVerify(params.packagesId,params.isVerified);
	else
		return {error = -1,msg = "Illegal operation"};
	end
end